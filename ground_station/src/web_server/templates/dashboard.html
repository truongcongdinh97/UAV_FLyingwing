<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flying Wing UAV - Ground Station Dashboard</title>
    
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        .header {
            background: #16213e;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 24px;
            color: #FFFFFF;
            text-shadow: 0 0 10px #00d4ff;
        }
        
        .status-indicator {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 60vh 40vh;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 70px);
        }
        
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            overflow: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .panel h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 8px;
        }
        
        #map {
            height: 100%;
            border-radius: 5px;
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .telemetry-item {
            background: #0f3460;
            padding: 12px;
            border-radius: 5px;
            border-left: 3px solid #00d4ff;
        }
        
        .telemetry-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .telemetry-value {
            font-size: 20px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .detection-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .detection-item {
            background: #0f3460;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #ff6b6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detection-class {
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .detection-confidence {
            color: #00ff88;
        }
        
        .image-preview {
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .alert {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            animation: alertBlink 1s infinite;
        }
        
        @keyframes alertBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .command-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .command-btn {
            background: #0f3460;
            color: #00d4ff;
            border: 2px solid #00d4ff;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .command-btn:hover {
            background: #00d4ff;
            color: #16213e;
            transform: scale(1.05);
        }
        
        .command-btn.danger {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .command-btn.danger:hover {
            background: #ff6b6b;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ©Ô∏è Flying Wing UAV - Ground Station</h1>
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connected</span>
            <span>|</span>
            <span id="timestamp">--:--:--</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Map Panel -->
        <div class="panel" style="grid-row: 1 / 3;">
            <h2>üìç Live Position</h2>
            <div id="map"></div>
        </div>
        
        <!-- Telemetry Panel -->
        <div class="panel">
            <h2>üìä Telemetry</h2>
            <div class="telemetry-grid">
                <div class="telemetry-item">
                    <div class="telemetry-label">Latitude</div>
                    <div class="telemetry-value" id="lat">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Longitude</div>
                    <div class="telemetry-value" id="lon">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Altitude (m)</div>
                    <div class="telemetry-value" id="altitude">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Speed (m/s)</div>
                    <div class="telemetry-value" id="speed">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Battery (%)</div>
                    <div class="telemetry-value" id="battery">--</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Heading (¬∞)</div>
                    <div class="telemetry-value" id="heading">--</div>
                </div>
            </div>
            
            <div class="command-panel">
                <button class="command-btn" onclick="sendCommand('ARM')">ARM</button>
                <button class="command-btn" onclick="sendCommand('TAKEOFF')">TAKEOFF</button>
                <button class="command-btn danger" onclick="sendCommand('RTH')">RTH</button>
                <button class="command-btn" onclick="sendCommand('LOITER')">LOITER</button>
                <button class="command-btn danger" onclick="sendCommand('LAND')">LAND</button>
                <button class="command-btn danger" onclick="sendCommand('DISARM')">DISARM</button>
            </div>
        </div>
        
        <!-- Detections Panel -->
        <div class="panel">
            <h2>üéØ AI Detections</h2>
            <div class="detection-list" id="detectionList">
                <p style="color: #888; text-align: center;">No detections yet...</p>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([21.028511, 105.804817], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // UAV marker
        let uavMarker = L.marker([21.028511, 105.804817], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            })
        }).addTo(map);

        // Target marker (m·ª•c ti√™u)
        let targetMarker = null;
        const targetIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // icon m·ª•c ti√™u
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        });

        // Path polyline
        let pathCoords = [];
        let pathLine = L.polyline(pathCoords, {color: 'red', weight: 2}).addTo(map);
        
        // Connect to WebSocket
        const socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('statusDot').style.background = '#00ff00';
            document.getElementById('statusText').textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('statusDot').style.background = '#ff0000';
            document.getElementById('statusText').textContent = 'Disconnected';
        });
        
        // Handle telemetry updates
        socket.on('telemetry_update', (data) => {
            console.log('Telemetry:', data);
            
            // Update display
            document.getElementById('lat').textContent = data.latitude?.toFixed(6) || '--';
            document.getElementById('lon').textContent = data.longitude?.toFixed(6) || '--';
            document.getElementById('altitude').textContent = data.altitude?.toFixed(1) || '--';
            document.getElementById('speed').textContent = data.speed?.toFixed(1) || '--';
            document.getElementById('battery').textContent = data.battery || '--';
            document.getElementById('heading').textContent = data.heading?.toFixed(0) || '--';
            
            // Update timestamp
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString();
            
            // Update map
            if (data.latitude && data.longitude) {
                const pos = [data.latitude, data.longitude];
                uavMarker.setLatLng(pos);
                
                // Add to path
                pathCoords.push(pos);
                if (pathCoords.length > 100) pathCoords.shift();
                pathLine.setLatLngs(pathCoords);
                
                // Center map on UAV
                map.setView(pos);
            }
        });
        
        // Handle target geolocation updates
        socket.on('target_update', (data) => {
            console.log('Target geolocation:', data);
            if (data.lat && data.lon) {
                const pos = [data.lat, data.lon];
                // N·∫øu ƒë√£ c√≥ marker th√¨ c·∫≠p nh·∫≠t v·ªã tr√≠, n·∫øu ch∆∞a th√¨ t·∫°o m·ªõi
                if (targetMarker) {
                    targetMarker.setLatLng(pos);
                } else {
                    targetMarker = L.marker(pos, {icon: targetIcon}).addTo(map);
                }
                // Center map on target
                map.setView(pos);
            }
        });
        
        // Handle detections
        socket.on('new_detection', (data) => {
            console.log('Detection:', data);
            
            const list = document.getElementById('detectionList');
            
            // Clear placeholder
            if (list.querySelector('p')) {
                list.innerHTML = '';
            }
            
            // Add detection
            const item = document.createElement('div');
            item.className = 'detection-item';
            item.innerHTML = `
                <div>
                    <span class="detection-class">${data.class}</span>
                    <span style="color: #888; font-size: 12px;">${new Date().toLocaleTimeString()}</span>
                </div>
                <span class="detection-confidence">${(data.confidence * 100).toFixed(0)}%</span>
            `;
            
            list.insertBefore(item, list.firstChild);
            
            // Keep only last 20
            while (list.children.length > 20) {
                list.removeChild(list.lastChild);
            }
        });
        
        // Send command
        function sendCommand(command) {
            console.log('Sending command:', command);
            
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command,
                    params: {}
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Command response:', data);
                alert(`Command ${command} sent!`);
            })
            .catch(error => {
                console.error('Command error:', error);
                alert('Failed to send command');
            });
        }
        
        // Update timestamp every second
        setInterval(() => {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString();
        }, 1000);
    </script>
</body>
</html>
