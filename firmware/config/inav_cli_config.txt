# iNav CLI Configuration Script
# Flying Wing UAV - Twin Engine Setup
# Use this after flashing firmware

# ===== RESET TO DEFAULTS =====
defaults nosave

# ===== MIXER CONFIGURATION =====
mixer CUSTOM
mmix reset

# Motor mixing (Twin-engine differential thrust)
# Format: mmix <motor> <throttle> <roll> <pitch> <yaw>
mmix 0 1.0 0.0 0.0 -0.5   # Motor 1 (Left): throttle - 50% yaw
mmix 1 1.0 0.0 0.0  0.5   # Motor 2 (Right): throttle + 50% yaw

# Servo mixing (Elevons)
# Format: smix <id> <servo> <source> <rate> <speed> <min> <max>
smix reset
smix 0 3 0  50 0 -100 100   # Elevon Left - Pitch
smix 1 3 1 -50 0 -100 100   # Elevon Left - Roll
smix 2 4 0  50 0 -100 100   # Elevon Right - Pitch  
smix 3 4 1  50 0 -100 100   # Elevon Right - Roll

# ===== SERIAL PORTS =====
# UART1: RC Receiver (SBUS/iBUS)
# UART2: GPS
# UART3: MAVLink (Companion Computer)
# USB: Configuration

serial 0 1 115200 115200 0 115200       # USB - Configuration
serial 1 64 115200 115200 0 115200      # UART1 - RC (SBUS)
serial 2 2 115200 115200 0 115200       # UART2 - GPS
serial 3 64 115200 115200 0 115200      # UART3 - MAVLink

# ===== FEATURES =====
feature -SOFTSERIAL
feature GPS
feature TELEMETRY
feature CURRENT_METER
feature VBAT

# ===== RC RECEIVER =====
set serialrx_provider = SBUS
set serialrx_inverted = ON
set serialrx_halfduplex = OFF

# RC channel mapping (AETR)
set rcmap = AETR1234

# RC smoothing
set rc_smoothing = ON
set rc_smoothing_auto_factor = 10

# ===== GPS =====
set gps_provider = UBLOX
set gps_sbas_mode = AUTO
set gps_auto_config = ON
set gps_auto_baud = ON
set gps_ublox_use_galileo = ON

# ===== BATTERY =====
# 4S LiPo (14.8V nominal, 16.8V max)
set bat_cells = 4
set vbat_max_cell_voltage = 420    # 4.20V per cell
set vbat_min_cell_voltage = 340    # 3.40V per cell (safe minimum)
set vbat_warning_cell_voltage = 350 # 3.50V warning
set vbat_scale = 110

# Current sensor
set ibat_scale = 400
set ibat_offset = 0

# Battery capacity (10400mAh)
set battery_capacity = 10400
set battery_capacity_warning = 3120  # 30%
set battery_capacity_critical = 2080 # 20%

# ===== FAILSAFE =====
set failsafe_procedure = RTH
set failsafe_delay = 10              # 10 seconds before action
set failsafe_off_delay = 5           # 5 seconds to disarm after landing
set failsafe_throttle = 1300         # Throttle value in failsafe
set failsafe_throttle_low_delay = 100

# GPS rescue
set failsafe_gps_rescue_min_sats = 6
set failsafe_gps_rescue_sanity_checks = ON

# ===== NAVIGATION =====
# RTH settings
set nav_rth_altitude = 50            # RTH at 50m
set nav_rth_climb_first = ON
set nav_rth_climb_ignore_emerg = OFF
set nav_rth_tail_first = OFF
set nav_rth_allow_landing = ON
set nav_rth_alt_mode = CURRENT

# Auto landing
set nav_disarm_on_landing = ON
set nav_landing_speed = 200          # 2 m/s descent

# Position hold
set nav_max_speed = 1500             # 15 m/s max
set nav_max_climb_rate = 500         # 5 m/s
set nav_manual_speed = 1000          # 10 m/s in manual
set nav_manual_climb_rate = 300      # 3 m/s

# Loiter
set nav_loiter_radius = 5000         # 50m radius (cm)

# Geofence
set nav_fw_control_smoothness = 0
set geozone_detection_distance = 0   # Disabled by default

# ===== FLIGHT MODES =====
# Mode channel setup (customize per your TX)
# Channel 5: ARM
# Channel 6: Flight modes (3-position switch)
# Channel 7: RTH

# ===== TUNING (PID) =====
# Flying wing presets - will need tuning
set fw_p_pitch = 15
set fw_i_pitch = 5
set fw_d_pitch = 5
set fw_ff_pitch = 80

set fw_p_roll = 15
set fw_i_roll = 3
set fw_d_roll = 7
set fw_ff_roll = 50

set fw_p_yaw = 20
set fw_i_yaw = 0
set fw_d_yaw = 0
set fw_ff_yaw = 100

# Rate profile
set roll_rate = 20
set pitch_rate = 15
set yaw_rate = 15

# ===== AIRFRAME =====
set platform_type = AIRPLANE
set model_preview_type = 26          # Flying wing

# Motor output
set motor_pwm_protocol = ONESHOT125
set motor_pwm_rate = 480

# Servo output
set servo_pwm_rate = 50

# Throttle
set throttle_idle = 5.0
set throttle_scale = 1.0

# Airspeed (if sensor available)
# set pitot_hardware = NONE

# ===== SAFETY =====
# Arming
set small_angle = 180                # Allow arm at any angle (for hand launch)
set auto_disarm_delay = 5

# Min throttle for arming
set min_check = 1050
set max_check = 1900

# ===== TELEMETRY =====
set telemetry_inverted = OFF
set report_cell_voltage = ON

# ===== BLACKBOX =====
set blackbox_rate_denom = 1
set blackbox_device = SERIAL

# ===== OSD (if available) =====
# set osd_video_system = AUTO

# ===== SAVE ALL SETTINGS =====
save

# After save, reboot and check:
# 1. status - verify sensors
# 2. Tasks - verify all tasks running
# 3. Calibrate accelerometer: acc calibration
# 4. Calibrate magnetometer: mag calibration
# 5. Set home: gpspassthrough - wait for 3D fix
